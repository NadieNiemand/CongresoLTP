<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Portal Congreso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .admin-container { background: #f8f9fa; min-height: 100vh; }
        .stats-card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="admin-container">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">üéì Panel de Administraci√≥n</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Herramientas de Administraci√≥n</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            
                            <a href="#workAssignments" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                                üë• Asignar Evaluadores
                            </a>
                            <a href="#systemStats" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                                üìä Estad√≠sticas
                            </a>
                        </div>
                    </div>
                </div>
            </div>

                    <!-- Asignar Evaluadores -->
                    <div class="tab-pane fade" id="workAssignments">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Asignar Evaluadores a Trabajos</h5>
                            </div>
                            <div class="card-body">
                                <div id="assignmentInterface">
                                    <!-- Interfaz de asignaci√≥n -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div class="tab-pane fade" id="systemStats">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="stats-card bg-primary text-white text-center p-3">
                                    <h3 id="totalUsers">0</h3>
                                    <small>Usuarios Registrados</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card bg-success text-white text-center p-3">
                                    <h3 id="totalWorks">0</h3>
                                    <small>Trabajos Enviados</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card bg-info text-white text-center p-3">
                                    <h3 id="totalEvaluations">0</h3>
                                    <small>Evaluaciones</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card bg-warning text-white text-center p-3">
                                    <h3 id="pendingAssignments">0</h3>
                                    <small>Asignaciones Pendientes</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script>
  
// Verificar autenticaci√≥n y permisos de administrador - VERSI√ìN MEJORADA
async function checkAdminAuth() {
    try {
        console.log('üîê Verificando permisos de administrador...');
        
        const { data: { session }, error } = await supabase.auth.getSession();
        if (!session || error) {
            console.error('‚ùå No hay sesi√≥n activa:', error);
            window.location.href = 'login.html';
            return false;
        }

        console.log('‚úÖ Sesi√≥n activa encontrada:', session.user.id);

        // Verificar que el usuario es administrador
        const user = session.user;
        const profile = await getUserProfile(user.id);
        
        console.log('üìã Perfil del usuario:', profile);
        
        if (!profile) {
            console.error('‚ùå No se pudo obtener el perfil del usuario');
            alert('Error: No se pudo verificar tu perfil de usuario.');
            window.location.href = 'login.html';
            return false;
        }
        
        if (profile.user_type !== 'admin') {
            console.error('‚ùå Usuario no es administrador. Tipo:', profile.user_type);
            alert('No tienes permisos para acceder al panel de administraci√≥n.');
            
            // Redirigir al dashboard apropiado
            if (profile.user_type === 'evaluator') {
                window.location.href = 'evaluator-dashboard.html';
            } else {
                window.location.href = 'student-dashboard.html';
            }
            return false;
        }

        console.log('‚úÖ Acceso de administrador confirmado');
        loadActiveCodes();
        loadSystemStats();
        return true;
        
    } catch (error) {
        console.error('‚ùå Error verificando permisos:', error);
        alert('Error verificando permisos: ' + error.message);
        window.location.href = 'login.html';
        return false;
    }
}

// Cargar estad√≠sticas del sistema
async function loadSystemStats() {
    try {
        // Obtener conteo de usuarios
        const { count: userCount } = await supabase
            .from('user_profiles')
            .select('*', { count: 'exact', head: true });

        // Obtener conteo de trabajos
        const { count: workCount } = await supabase
            .from('works')
            .select('*', { count: 'exact', head: true });

        // Obtener conteo de evaluaciones
        const { count: evaluationCount } = await supabase
            .from('evaluations')
            .select('*', { count: 'exact', head: true });

        // Obtener conteo de c√≥digos activos
        const { count: activeCodeCount } = await supabase
            .from('invitation_codes')
            .select('*', { count: 'exact', head: true })
            .eq('is_active', true)
            .is('used_by', null);

        // Actualizar la UI
        document.getElementById('totalUsers').textContent = userCount || 0;
        document.getElementById('totalWorks').textContent = workCount || 0;
        document.getElementById('totalEvaluations').textContent = evaluationCount || 0;
        document.getElementById('pendingAssignments').textContent = activeCodeCount || 0;

    } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
    }
}

// Inicializar el panel
document.addEventListener('DOMContentLoaded', function() {
    checkAdminAuth();
    
    // Configurar tabs de Bootstrap
    const triggerTabList = [].slice.call(document.querySelectorAll('a[data-bs-toggle="tab"]'));
    triggerTabList.forEach(function (triggerEl) {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            tabTrigger.show();
        });
    });
});
    </script>
</body>
</html>