<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Portal Congreso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .admin-container { background: #f8f9fa; min-height: 100vh; }
        .stats-card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="admin-container">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">üéì Panel de Administraci√≥n</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Herramientas de Administraci√≥n</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <a href="#invitationCodes" class="list-group-item list-group-item-action active" data-bs-toggle="tab">
                                üìß C√≥digos de Invitaci√≥n
                            </a>
                            <a href="#workAssignments" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                                üë• Asignar Evaluadores
                            </a>
                            <a href="#systemStats" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                                üìä Estad√≠sticas
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido -->
            <div class="col-lg-9">
                <div class="tab-content">
                    <!-- C√≥digos de Invitaci√≥n -->
                    <div class="tab-pane fade show active" id="invitationCodes">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Generar C√≥digos de Invitaci√≥n</h5>
                            </div>
                            <div class="card-body">
                                <form id="generateCodeForm">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">N√∫mero de c√≥digos</label>
                                            <input type="number" class="form-control" id="codeCount" min="1" max="50" value="5">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">D√≠as de validez</label>
                                            <input type="number" class="form-control" id="validityDays" min="1" max="365" value="30">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="submit" class="btn btn-primary w-100">Generar C√≥digos</button>
                                        </div>
                                    </div>
                                </form>
                                
                                <div class="mt-4">
                                    <h6>C√≥digos Generados</h6>
                                    <div id="generatedCodes" class="bg-light p-3 rounded">
                                        <!-- Los c√≥digos aparecer√°n aqu√≠ -->
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h6>C√≥digos Activos</h6>
                                    <div id="activeCodesList">
                                        <!-- Lista de c√≥digos activos -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Asignar Evaluadores -->
                    <div class="tab-pane fade" id="workAssignments">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Asignar Evaluadores a Trabajos</h5>
                            </div>
                            <div class="card-body">
                                <div id="assignmentInterface">
                                    <!-- Interfaz de asignaci√≥n -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div class="tab-pane fade" id="systemStats">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="stats-card bg-primary text-white text-center p-3">
                                    <h3 id="totalUsers">0</h3>
                                    <small>Usuarios Registrados</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card bg-success text-white text-center p-3">
                                    <h3 id="totalWorks">0</h3>
                                    <small>Trabajos Enviados</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card bg-info text-white text-center p-3">
                                    <h3 id="totalEvaluations">0</h3>
                                    <small>Evaluaciones</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card bg-warning text-white text-center p-3">
                                    <h3 id="pendingAssignments">0</h3>
                                    <small>Asignaciones Pendientes</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script>
    // Verificar autenticaci√≥n y permisos de administrador
// Verificar autenticaci√≥n y permisos de administrador - VERSI√ìN MEJORADA
async function checkAdminAuth() {
    try {
        console.log('üîê Verificando permisos de administrador...');
        
        const { data: { session }, error } = await supabase.auth.getSession();
        if (!session || error) {
            console.error('‚ùå No hay sesi√≥n activa:', error);
            window.location.href = 'login.html';
            return false;
        }

        console.log('‚úÖ Sesi√≥n activa encontrada:', session.user.id);

        // Verificar que el usuario es administrador
        const user = session.user;
        const profile = await getUserProfile(user.id);
        
        console.log('üìã Perfil del usuario:', profile);
        
        if (!profile) {
            console.error('‚ùå No se pudo obtener el perfil del usuario');
            alert('Error: No se pudo verificar tu perfil de usuario.');
            window.location.href = 'login.html';
            return false;
        }
        
        if (profile.user_type !== 'admin') {
            console.error('‚ùå Usuario no es administrador. Tipo:', profile.user_type);
            alert('No tienes permisos para acceder al panel de administraci√≥n.');
            
            // Redirigir al dashboard apropiado
            if (profile.user_type === 'evaluator') {
                window.location.href = 'evaluator-dashboard.html';
            } else {
                window.location.href = 'student-dashboard.html';
            }
            return false;
        }

        console.log('‚úÖ Acceso de administrador confirmado');
        loadActiveCodes();
        loadSystemStats();
        return true;
        
    } catch (error) {
        console.error('‚ùå Error verificando permisos:', error);
        alert('Error verificando permisos: ' + error.message);
        window.location.href = 'login.html';
        return false;
    }
}

// Generar c√≥digos de invitaci√≥n
document.getElementById('generateCodeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const codeCount = parseInt(document.getElementById('codeCount').value);
    const validityDays = parseInt(document.getElementById('validityDays').value);
    
    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    
    try {
        submitButton.innerHTML = 'Generando...';
        submitButton.disabled = true;
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Usuario no autenticado');

        // Generar c√≥digos
        const codes = [];
        for (let i = 0; i < codeCount; i++) {
            const code = generateRandomCode(12);
            codes.push(code);
        }

        // Calcular fecha de expiraci√≥n
        const expiresAt = new Date();
        expiresAt.setDate(expiresAt.getDate() + validityDays);

        // Insertar c√≥digos en la base de datos
        const codeInserts = codes.map(code => ({
            code,
            created_by: user.id,
            expires_at: expiresAt.toISOString(),
            is_active: true
        }));

        const { data, error } = await supabase
            .from('invitation_codes')
            .insert(codeInserts)
            .select();

        if (error) throw error;

        // Mostrar c√≥digos generados
        displayGeneratedCodes(codes);
        
        // Recargar lista de c√≥digos activos
        await loadActiveCodes();
        
        alert(`‚úÖ ${codeCount} c√≥digos generados exitosamente`);

    } catch (error) {
        console.error('Error generando c√≥digos:', error);
        alert('‚ùå Error generando c√≥digos: ' + error.message);
    } finally {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
});

// Funci√≥n para generar c√≥digo aleatorio
function generateRandomCode(length) {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    // Formato: XXX-XXX-XXX
    return result.replace(/(\w{4})(\w{4})(\w{4})/, '$1-$2-$3');
}

// Mostrar c√≥digos generados
function displayGeneratedCodes(codes) {
    const container = document.getElementById('generatedCodes');
    const codesHTML = codes.map(code => `
        <div class="alert alert-success d-flex justify-content-between align-items-center">
            <code class="fs-6">${code}</code>
            <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${code}')">
                üìã Copiar
            </button>
        </div>
    `).join('');
    
    container.innerHTML = codesHTML;
}

// Copiar c√≥digo al portapapeles
function copyToClipboard(text) {
    navigator.clipboard.writeText(text.replace(/-/g, '')).then(() => {
        alert('‚úÖ C√≥digo copiado al portapapeles: ' + text);
    });
}

// Cargar c√≥digos activos
async function loadActiveCodes() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        
        const { data, error } = await supabase
            .from('invitation_codes')
            .select(`
                *,
                user_profiles!created_by (name),
                used_profiles:user_profiles!used_by (name)
            `)
            .eq('is_active', true)
            .gte('expires_at', new Date().toISOString())
            .order('created_at', { ascending: false });

        if (error) throw error;

        const container = document.getElementById('activeCodesList');
        
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No hay c√≥digos activos.</div>';
            return;
        }

        container.innerHTML = data.map(code => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="card-title">
                                <code>${code.code}</code>
                                ${code.used_by ? 
                                    '<span class="badge bg-success ms-2">Usado</span>' : 
                                    '<span class="badge bg-warning ms-2">Disponible</span>'
                                }
                            </h6>
                            <p class="card-text mb-1">
                                <small class="text-muted">
                                    Creado por: ${code.user_profiles?.name || 'N/A'}<br>
                                    Expira: ${new Date(code.expires_at).toLocaleDateString()}
                                </small>
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            ${code.used_by ? `
                                <p class="mb-1">
                                    <small>Usado por: ${code.used_profiles?.name || 'N/A'}</small>
                                </p>
                            ` : `
                                <button class="btn btn-sm btn-outline-danger" onclick="deactivateCode('${code.id}')">
                                    üóëÔ∏è Desactivar
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error cargando c√≥digos activos:', error);
        document.getElementById('activeCodesList').innerHTML = 
            '<div class="alert alert-danger">Error cargando c√≥digos activos</div>';
    }
}

// Desactivar c√≥digo
async function deactivateCode(codeId) {
    if (!confirm('¬øEst√°s seguro de que quieres desactivar este c√≥digo?')) return;

    try {
        const { error } = await supabase
            .from('invitation_codes')
            .update({ is_active: false })
            .eq('id', codeId);

        if (error) throw error;

        alert('‚úÖ C√≥digo desactivado exitosamente');
        await loadActiveCodes();
        
    } catch (error) {
        console.error('Error desactivando c√≥digo:', error);
        alert('‚ùå Error desactivando c√≥digo: ' + error.message);
    }
}

// Cargar estad√≠sticas del sistema
async function loadSystemStats() {
    try {
        // Obtener conteo de usuarios
        const { count: userCount } = await supabase
            .from('user_profiles')
            .select('*', { count: 'exact', head: true });

        // Obtener conteo de trabajos
        const { count: workCount } = await supabase
            .from('works')
            .select('*', { count: 'exact', head: true });

        // Obtener conteo de evaluaciones
        const { count: evaluationCount } = await supabase
            .from('evaluations')
            .select('*', { count: 'exact', head: true });

        // Obtener conteo de c√≥digos activos
        const { count: activeCodeCount } = await supabase
            .from('invitation_codes')
            .select('*', { count: 'exact', head: true })
            .eq('is_active', true)
            .is('used_by', null);

        // Actualizar la UI
        document.getElementById('totalUsers').textContent = userCount || 0;
        document.getElementById('totalWorks').textContent = workCount || 0;
        document.getElementById('totalEvaluations').textContent = evaluationCount || 0;
        document.getElementById('pendingAssignments').textContent = activeCodeCount || 0;

    } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
    }
}

// Inicializar el panel
document.addEventListener('DOMContentLoaded', function() {
    checkAdminAuth();
    
    // Configurar tabs de Bootstrap
    const triggerTabList = [].slice.call(document.querySelectorAll('a[data-bs-toggle="tab"]'));
    triggerTabList.forEach(function (triggerEl) {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            tabTrigger.show();
        });
    });
});
    </script>
</body>
</html>