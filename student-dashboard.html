<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Alumno - Portal Congreso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">üéì Congreso Estudiantil "Laboratorios de Ingenier√≠a Qu√≠mica"</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">üë®‚Äçüéì Bienvenido, Alumno</span>
                <a class="nav-link" href="index.html">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Mis Trabajos Enviados</h2>
                    <a href="submit-work.html" class="btn btn-primary">
                        üìÑ Nuevo Trabajo
                    </a>
                </div>
                
                <div id="worksList">
                    <!-- Los trabajos se cargar√°n aqu√≠ con JavaScript -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando trabajos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts existentes -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/app.js"></script>

    <!-- NUEVO SCRIPT PARA EL DASHBOARD DEL ALUMNO -->
    <script>
        // Funciones espec√≠ficas para el dashboard del alumno
        async function loadStudentWorks() {
            try {
                console.log('üì• Cargando trabajos del alumno...');
                
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError) throw userError;
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                console.log('üë§ Usuario:', user.id);

                // Cargar trabajos del usuario actual desde Supabase
                const works = await getStudentWorks(user.id);
                console.log('üìã Trabajos encontrados:', works);
                
                displayWorks(works, 'student');
                
            } catch (error) {
                console.error('‚ùå Error cargando trabajos:', error);
                const worksContainer = document.getElementById('worksList');
                if (worksContainer) {
                    worksContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error cargando trabajos:</strong> ${error.message}
                            <br><small>Verifica la consola para m√°s detalles</small>
                        </div>
                    `;
                }
            }
        }

        // Funci√≥n mejorada para mostrar trabajos
        function displayWorks(works, userType) {
            const worksContainer = document.getElementById('worksList');
            if (!worksContainer) return;
            
            if (!works || works.length === 0) {
                worksContainer.innerHTML = `
                    <div class="text-center py-5">
                        <div class="text-muted">
                            <p class="h3">üìù</p>
                            <p class="h5">No hay trabajos enviados</p>
                            <p class="mb-0">Env√≠a tu primer trabajo usando el bot√≥n "Nuevo Trabajo"</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            worksContainer.innerHTML = works.map(work => {
                const statusClass = `status-${work.status.toLowerCase().replace(' ', '-')}`;
                const statusText = getStatusText(work.status);
                
                return `
                    <div class="work-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="text-primary">${work.title}</h5>
                                <p class="mb-1"><strong>Estado:</strong> <span class="${statusClass}">${statusText}</span></p>
                                <p class="mb-1"><strong>Fecha de env√≠o:</strong> ${new Date(work.submitted_at).toLocaleDateString('es-ES')}</p>
                                <p class="mb-1"><strong>Modalidad:</strong> ${work.modality === 'ponencia' ? 'Ponencia' : 'P√≥ster'}</p>
                                <p class="mb-1"><strong>Archivo:</strong> 
                                    <a href="${work.file_url}" target="_blank" class="text-decoration-none">
                                        üìé Ver archivo
                                    </a>
                                </p>
                            </div>
                            <div class="ms-3">
                                <span class="badge bg-${work.modality === 'ponencia' ? 'primary' : 'success'}">
                                    ${work.modality === 'ponencia' ? 'Ponencia' : 'P√≥ster'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Funci√≥n para obtener texto del estado
        function getStatusText(status) {
            const statusMap = {
                'pending': 'üìù Pendiente de revisi√≥n',
                'under_review': 'üîç En revisi√≥n',
                'accepted_oral': '‚úÖ Aceptado como Ponencia',
                'accepted_poster': '‚úÖ Aceptado como P√≥ster',
                'rejected': '‚ùå Rechazado'
            };
            return statusMap[status] || status;
        }

        // Llamar a la funci√≥n cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentWorks();
        });
    </script>
</body>
</html>