<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Portal Congreso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">üéì Congreso Acad√©mico</a>
        </div>
    </nav>

    <div class="container login-container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card login-card shadow">
                    <div class="card-header text-center">
                        <h4 class="mb-0">Crear Cuenta</h4>
                    </div>
                    <div class="card-body p-4">
                        <form id="registerForm">
                            <div class="mb-3">
                                <label for="name" class="form-label">Nombre Completo *</label>
                                <input type="text" class="form-control" id="name" placeholder="Juan P√©rez Garc√≠a" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Correo Electr√≥nico *</label>
                                <input type="email" class="form-control" id="email" placeholder="tu@ejemplo.com" required>
                            </div>
                            <div class="mb-3">
                                <label for="userType" class="form-label">Tipo de Usuario *</label>
                                <select class="form-select" id="userType" required>
                                    <option value="">Seleccionar tipo de usuario...</option>
                                    <option value="student">Alumno</option>
                                    <option value="evaluator">Evaluador/Profesor</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Contrase√±a *</label>
                                <input type="password" class="form-control" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
                                <div class="form-text">M√≠nimo 6 caracteres</div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirmar Contrase√±a *</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <!-- A√±ade este campo en el formulario de registro -->
<div class="mb-3" id="invitationCodeField" style="display: none;">
    <label for="invitationCode" class="form-label">C√≥digo de Invitaci√≥n *</label>
    <input type="text" class="form-control" id="invitationCode" 
           placeholder="Ingresa el c√≥digo proporcionado por el administrador">
    <div class="form-text">Solo necesario para registrarse como evaluador</div>
</div> 

                            <div class="alert alert-info">
                                <strong>‚ÑπÔ∏è Informaci√≥n importante:</strong><br>
                                ‚Ä¢ Los evaluadores deben ser aprobados por el comit√© organizador<br>
                                ‚Ä¢ Los alumnos pueden enviar m√∫ltiples trabajos<br>
                                ‚Ä¢ Recibir√°s un email de confirmaci√≥n
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 py-2">
                                <span id="registerText">Crear Cuenta</span>
                                <div id="registerSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </button>
                        </form>
                        
                        <div class="text-center mt-3">
                            <a href="login.html">¬øYa tienes cuenta? Inicia Sesi√≥n</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incluir Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script>
        // Manejar el registro de usuarios
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
            }
        });

        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const userType = document.getElementById('userType').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const registerText = document.getElementById('registerText');
            const registerSpinner = document.getElementById('registerSpinner');
            
            // Validaciones b√°sicas
            if (password !== confirmPassword) {
                alert('‚ùå Las contrase√±as no coinciden');
                return;
            }
            
            if (password.length < 6) {
                alert('‚ùå La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            if (!userType) {
                alert('‚ùå Por favor selecciona un tipo de usuario');
                return;
            }
            
            // Mostrar loading
            registerText.textContent = 'Creando cuenta...';
            registerSpinner.classList.remove('d-none');
            document.querySelector('button[type="submit"]').disabled = true;
            
            try {
                console.log('üìù Intentando registrar usuario:', { email, name, userType });
                
                // Usar la funci√≥n de registro que ya est√° en supabase-client.js
                const result = await registerUser(email, password, name, userType);
                
                if (result.success) {
                    registerText.textContent = '¬°Cuenta creada!';
                    
                    // Mostrar mensaje de √©xito
                    alert('‚úÖ Cuenta creada exitosamente. Ya puedes iniciar sesi√≥n.');
                    
                    // Redirigir al login despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('‚ùå Error en registro:', error);
                registerText.textContent = 'Crear Cuenta';
                registerSpinner.classList.add('d-none');
                document.querySelector('button[type="submit"]').disabled = false;
                
                // Mostrar error espec√≠fico
                let errorMessage = 'Error al crear la cuenta';
                if (error.message.includes('User already registered')) {
                    errorMessage = 'Este email ya est√° registrado';
                } else if (error.message.includes('Password should be at least')) {
                    errorMessage = 'La contrase√±a debe tener al menos 6 caracteres';
                } else if (error.message.includes('Invalid email')) {
                    errorMessage = 'El formato del email no es v√°lido';
                } else {
                    errorMessage = error.message;
                }
                
                alert('‚ùå ' + errorMessage);
            }
        }
    </script>

    <script>
// Mostrar/ocultar campo de c√≥digo seg√∫n tipo de usuario
document.getElementById('userType').addEventListener('change', function() {
    const codeField = document.getElementById('invitationCodeField');
    codeField.style.display = this.value === 'evaluator' ? 'block' : 'none';
});

// Validar c√≥digo en el registro
async function validateInvitationCode(code) {
    const { data, error } = await supabase
        .from('invitation_codes')
        .select('*')
        .eq('code', code)
        .eq('is_active', true)
        .gte('expires_at', new Date().toISOString())
        .is('used_by', null)
        .single();
    
    return { valid: !!data && !error, codeData: data };
// Manejar el registro de usuarios CON validaci√≥n de c√≥digos
document.addEventListener('DOMContentLoaded', function() {
    const registerForm = document.getElementById('registerForm');
    const userTypeSelect = document.getElementById('userType');
    const invitationCodeField = document.getElementById('invitationCodeField');
    
    if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
    }
    
    if (userTypeSelect && invitationCodeField) {
        userTypeSelect.addEventListener('change', function() {
            // Mostrar campo de c√≥digo solo para evaluadores
            invitationCodeField.style.display = this.value === 'evaluator' ? 'block' : 'none';
            
            // Hacer requerido o no el campo de c√≥digo
            const codeInput = document.getElementById('invitationCode');
            if (codeInput) {
                codeInput.required = this.value === 'evaluator';
            }
        });
    }
});

async function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const userType = document.getElementById('userType').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const invitationCode = userType === 'evaluator' ? document.getElementById('invitationCode').value : null;
    
    const registerText = document.getElementById('registerText');
    const registerSpinner = document.getElementById('registerSpinner');
    const submitButton = document.querySelector('button[type="submit"]');
    
    // Validaciones b√°sicas
    if (password !== confirmPassword) {
        alert('‚ùå Las contrase√±as no coinciden');
        return;
    }
    
    if (password.length < 6) {
        alert('‚ùå La contrase√±a debe tener al menos 6 caracteres');
        return;
    }
    
    if (!userType) {
        alert('‚ùå Por favor selecciona un tipo de usuario');
        return;
    }
    
    // Validaci√≥n especial para evaluadores
    if (userType === 'evaluator' && (!invitationCode || invitationCode.trim() === '')) {
        alert('‚ùå Los evaluadores deben proporcionar un c√≥digo de invitaci√≥n');
        return;
    }
    
    // Mostrar loading
    registerText.textContent = 'Creando cuenta...';
    registerSpinner.classList.remove('d-none');
    submitButton.disabled = true;
    
    try {
        console.log('üìù Iniciando registro...', { email, name, userType });
        
        // VALIDAR C√ìDIGO DE INVITACI√ìN PARA EVALUADORES
        if (userType === 'evaluator') {
            console.log('üîê Validando c√≥digo de invitaci√≥n:', invitationCode);
            const codeValidation = await validateInvitationCode(invitationCode);
            
            if (!codeValidation.valid) {
                throw new Error(codeValidation.error || 'C√≥digo de invitaci√≥n inv√°lido o expirado');
            }
            
            console.log('‚úÖ C√≥digo validado correctamente');
        }
        
        // Registrar usuario
        const result = await registerUser(email, password, name, userType);
        
        if (result.success) {
            // MARCAR C√ìDIGO COMO USADO PARA EVALUADORES
            if (userType === 'evaluator' && invitationCode) {
                try {
                    await markInvitationCodeAsUsed(invitationCode, result.data.user.id);
                    console.log('‚úÖ C√≥digo marcado como usado');
                } catch (codeError) {
                    console.error('Error marcando c√≥digo como usado:', codeError);
                    // No detenemos el registro por este error
                }
            }
            
            registerText.textContent = '¬°Cuenta creada!';
            
            // Mostrar mensaje de √©xito
            alert('‚úÖ Cuenta creada exitosamente. Ya puedes iniciar sesi√≥n.');
            
            // Redirigir al login despu√©s de 2 segundos
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('‚ùå Error en registro:', error);
        registerText.textContent = 'Crear Cuenta';
        registerSpinner.classList.add('d-none');
        submitButton.disabled = false;
        
        // Mostrar error espec√≠fico
        let errorMessage = 'Error al crear la cuenta';
        if (error.message.includes('User already registered')) {
            errorMessage = 'Este email ya est√° registrado';
        } else if (error.message.includes('Password should be at least')) {
            errorMessage = 'La contrase√±a debe tener al menos 6 caracteres';
        } else if (error.message.includes('Invalid email')) {
            errorMessage = 'El formato del email no es v√°lido';
        } else if (error.message.includes('invitation')) {
            errorMessage = error.message;
        } else {
            errorMessage = error.message;
        }
        
        alert('‚ùå ' + errorMessage);
    }
}


}
</script>
</body>
</html>